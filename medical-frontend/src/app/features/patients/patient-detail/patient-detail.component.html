<div class="flex h-screen w-full overflow-hidden bg-background-light dark:bg-background-dark">
  <!-- SideNavBar -->
  <app-sidebar></app-sidebar>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col h-full relative overflow-hidden">
    <!-- TopNavBar -->
    <app-header></app-header>

    <!-- Scrollable Page Content -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" *ngIf="patient">
      <div class="max-w-[1200px] mx-auto flex flex-col gap-6">
        <!-- Profile Header Card -->
        <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
          <div class="flex flex-col md:flex-row gap-6">
            <!-- Avatar -->
            <div class="shrink-0">
              <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white text-4xl font-bold shadow-lg">
                {{ getInitials(patient) }}
              </div>
            </div>

            <!-- Info & Badges -->
            <div class="flex-1 flex flex-col justify-center gap-4">
              <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
                <div>
                  <h1 class="text-2xl font-bold text-slate-900 dark:text-white mb-1">
                    {{ patient.prenom }} {{ patient.nom }}
                  </h1>
                  <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-slate-500 dark:text-slate-400 text-sm">
                    <span class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-[18px]">cake</span>
                      {{ formatDateOfBirth(patient.dateNaissance) }} ({{ calculateAge(patient.dateNaissance) }}y)
                    </span>
                    <span class="hidden sm:inline">•</span>
                    <span class="flex items-center gap-1" *ngIf="patient.groupeSanguin">
                      <span class="material-symbols-outlined text-[18px]">water_drop</span>
                      Blood: {{ patient.groupeSanguin }}
                    </span>
                    <span class="hidden sm:inline">•</span>
                    <span class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-[18px]">id_card</span>
                      ID: {{ patient.numeroSecu }}
                    </span>
                  </div>
                  <p class="text-slate-400 text-xs mt-1">
                    Patient since {{ patient.dateCreation | date:'yyyy' }} • Last visit: 2 weeks ago
                  </p>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-3">
                  <button
                    class="hidden lg:flex h-9 items-center justify-center px-4 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 text-sm font-semibold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                    (click)="editPatient()">
                    Edit Profile
                  </button>
                  <button
                    class="h-9 flex items-center justify-center gap-2 px-4 rounded-lg bg-primary hover:bg-blue-700 text-white text-sm font-semibold shadow-sm transition-colors"
                    (click)="bookAppointment()">
                    <span class="material-symbols-outlined text-[20px]">calendar_add_on</span>
                    <span class="truncate">Book Appointment</span>
                  </button>
                </div>
              </div>

              <!-- Chips -->
              <div class="flex flex-wrap gap-2 mt-1">
                <!-- Allergy Warning -->
                <div
                  *ngIf="patient.allergies"
                  class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50 text-red-700 dark:text-red-400">
                  <span class="material-symbols-outlined text-[18px]">warning</span>
                  <span class="text-xs font-semibold uppercase tracking-wide">Allergy: {{ patient.allergies }}</span>
                </div>

                <!-- Chronic Diseases -->
                <div
                  *ngFor="let maladie of getChronicDiseasesList(patient.maladiesChroniques)"
                  class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800/50 text-orange-700 dark:text-orange-400">
                  <span class="material-symbols-outlined text-[18px]">medical_services</span>
                  <span class="text-xs font-medium">{{ maladie }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabs & Content Area -->
        <div class="flex flex-col gap-0">
          <!-- Tab Navigation -->
          <div class="flex border-b border-slate-200 dark:border-slate-700 bg-surface-light dark:bg-surface-dark px-6 pt-2 rounded-t-xl">
            <button
              class="flex items-center gap-2 px-4 py-3 border-b-[3px] transition-colors"
              [class.border-primary]="activeTab === 'history'"
              [class.text-primary]="activeTab === 'history'"
              [class.dark:text-blue-400]="activeTab === 'history'"
              [class.border-transparent]="activeTab !== 'history'"
              [class.text-slate-500]="activeTab !== 'history'"
              [class.hover:text-slate-700]="activeTab !== 'history'"
              [class.dark:text-slate-400]="activeTab !== 'history'"
              [class.dark:hover:text-slate-200]="activeTab !== 'history'"
              (click)="activeTab = 'history'">
              <span class="material-symbols-outlined text-[20px]">history</span>
              History
            </button>
            <button
              class="flex items-center gap-2 px-4 py-3 border-b-[3px] transition-colors"
              [class.border-primary]="activeTab === 'new'"
              [class.text-primary]="activeTab === 'new'"
              [class.dark:text-blue-400]="activeTab === 'new'"
              [class.border-transparent]="activeTab !== 'new'"
              [class.text-slate-500]="activeTab !== 'new'"
              [class.hover:text-slate-700]="activeTab !== 'new'"
              [class.dark:text-slate-400]="activeTab !== 'new'"
              [class.dark:hover:text-slate-200]="activeTab !== 'new'"
              (click)="activeTab = 'new'">
              <span class="material-symbols-outlined text-[20px]">edit_note</span>
              New Record
            </button>
            <button
              class="flex items-center gap-2 px-4 py-3 border-b-[3px] transition-colors"
              [class.border-primary]="activeTab === 'documents'"
              [class.text-primary]="activeTab === 'documents'"
              [class.dark:text-blue-400]="activeTab === 'documents'"
              [class.border-transparent]="activeTab !== 'documents'"
              [class.text-slate-500]="activeTab !== 'documents'"
              [class.hover:text-slate-700]="activeTab !== 'documents'"
              [class.dark:text-slate-400]="activeTab !== 'documents'"
              [class.dark:hover:text-slate-200]="activeTab !== 'documents'"
              (click)="activeTab = 'documents'">
              <span class="material-symbols-outlined text-[20px]">folder_open</span>
              Documents
            </button>
          </div>

          <!-- Tab Content -->
          <div class="bg-surface-light dark:bg-surface-dark border-x border-b border-slate-200 dark:border-slate-700 rounded-b-xl p-6 min-h-[500px]">

            <!-- History Tab -->
            <div *ngIf="activeTab === 'history'">
              <!-- Toolbar for History -->
              <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Medical Timeline</h2>
                <div class="flex items-center gap-2">
                  <select
                    class="form-select bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-600 rounded-lg text-sm py-2 pl-3 pr-8 focus:ring-primary focus:border-primary"
                    [(ngModel)]="filterType">
                    <option value="all">All Records</option>
                    <option value="Cardiology">Cardiology</option>
                    <option value="Dermatology">Dermatology</option>
                    <option value="Pediatrics">Pediatrics</option>
                    <option value="General">General</option>
                  </select>
                  <button class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                    <span class="material-symbols-outlined text-[20px]">filter_list</span>
                  </button>
                  <button class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                    <span class="material-symbols-outlined text-[20px]">print</span>
                  </button>
                </div>
              </div>

              <!-- Timeline -->
              <div class="relative pl-4 sm:pl-10 space-y-8 before:absolute before:left-[19px] sm:before:left-[43px] before:top-2 before:h-full before:w-[2px] before:bg-slate-200 dark:before:bg-slate-700">

                <div *ngFor="let dossier of filteredDossiers" class="relative">
                  <div class="absolute -left-[27px] sm:-left-[51px] top-1.5 flex h-10 w-10 items-center justify-center rounded-full border-4 border-white dark:border-surface-dark shadow-sm"
                       [ngClass]="getConsultationBgClass(dossier.typeConsultation)">
                    <span class="material-symbols-outlined text-[20px]" [ngClass]="getConsultationTextClass(dossier.typeConsultation)">
                      {{ getConsultationIcon(dossier.typeConsultation) }}
                    </span>
                  </div>

                  <div class="flex flex-col sm:flex-row gap-4">
                    <div class="sm:w-32 flex-shrink-0 pt-2">
                      <p class="text-sm font-bold text-slate-900 dark:text-white">
                        {{ formatConsultationDate(dossier.dateConsultation) }}
                      </p>
                      <p class="text-xs text-slate-500">
                        {{ formatConsultationTime(dossier.dateConsultation) }}
                      </p>
                    </div>

                    <div class="flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow">
                      <div class="flex justify-between items-start mb-2">
                        <div>
                          <h3 class="text-base font-bold text-slate-900 dark:text-white">
                            {{ dossier.typeConsultation }} Consultation
                          </h3>
                          <p class="text-sm text-primary font-medium">{{ dossier.medecin }}</p>
                        </div>
                      </div>

                      <p class="text-sm text-slate-600 dark:text-slate-300 mb-4 leading-relaxed">
                        {{ dossier.diagnostic }}
                      </p>

                      <div class="bg-slate-50 dark:bg-slate-900/50 rounded-md p-3 border border-slate-100 dark:border-slate-700/50">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="material-symbols-outlined text-slate-400 text-[18px]">prescriptions</span>
                          <span class="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wide">Prescribed</span>
                        </div>
                        <div class="text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap">
                          {{ dossier.traitement }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

              <!-- Load More -->
              <div class="mt-8 text-center" *ngIf="dossiers.length > displayedDossiers">
                <button
                  class="text-sm font-medium text-primary hover:text-blue-700 flex items-center justify-center gap-1 mx-auto transition-colors"
                  (click)="loadMoreDossiers()">
                  View Older Records
                  <span class="material-symbols-outlined text-[16px]">expand_more</span>
                </button>
              </div>
            </div>

            <!-- New Record Tab -->
            <div *ngIf="activeTab === 'new'">
              <app-dossier-form [patientId]="patient.id!" (dossierCreated)="onDossierCreated($event)"></app-dossier-form>
            </div>

            <!-- Documents Tab -->
            <div *ngIf="activeTab === 'documents'">
              <p class="text-slate-500 dark:text-slate-400 text-center py-12">Documents section coming soon...</p>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex-1 flex items-center justify-center">
      <app-loading></app-loading>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="flex-1 flex items-center justify-center">
      <div class="text-center">
        <span class="material-symbols-outlined text-6xl text-red-500 mb-4">error</span>
        <p class="text-xl font-semibold text-slate-900 dark:text-white mb-2">Error Loading Patient</p>
        <p class="text-slate-500 dark:text-slate-400">{{ error }}</p>
      </div>
    </div>
  </main>
</div>
